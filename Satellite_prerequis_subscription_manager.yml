Parfait üëç !
Tu veux donc enrichir ton r√¥le satellite_prereqs pour v√©rifier la disponibilit√© du package subscription-manager (dans les d√©p√¥ts) et l‚Äôinstaller automatiquement s‚Äôil est manquant.

Je te donne ci-dessous le code complet et d√©taill√© du fichier mis √† jour :
il s‚Äôagit du fichier roles/satellite_prereqs/tasks/30_package_mgr.yml, enti√®rement pr√™t √† copier/coller dans ton projet.


---

‚úÖ roles/satellite_prereqs/tasks/30_package_mgr.yml

---
# ======================================================================
# V√©rification du gestionnaire de paquets et du package subscription-manager
# ======================================================================

- name: "D√©tecter gestionnaire de paquets"
  ansible.builtin.set_fact:
    _pkg_mgr: "{{ 'dnf' if ansible_facts.pkg_mgr == 'dnf' else 'yum' }}"

# ----------------------------------------------------------------------
# 1Ô∏è‚É£ V√©rification pr√©sence du package
# ----------------------------------------------------------------------
- name: "V√©rifier si subscription-manager est install√©"
  ansible.builtin.command: "rpm -q subscription-manager"
  changed_when: false
  register: _rhsm_rpm
  failed_when: false

# ----------------------------------------------------------------------
# 2Ô∏è‚É£ Installation si absent
# ----------------------------------------------------------------------
- name: "Installer subscription-manager s'il est manquant"
  when: _rhsm_rpm.rc != 0
  block:
    - name: "V√©rifier disponibilit√© du package dans les d√©p√¥ts activ√©s"
      ansible.builtin.command: "{{ _pkg_mgr }} list subscription-manager"
      register: _rhsm_check_repo
      changed_when: false
      failed_when: false

    - name: "Installer subscription-manager depuis d√©p√¥t si disponible"
      when: _rhsm_check_repo.rc == 0
      ansible.builtin.package:
        name: subscription-manager
        state: present
      register: _rhsm_install

    - name: "Message si le package n'est pas disponible dans les d√©p√¥ts"
      when: _rhsm_check_repo.rc != 0
      ansible.builtin.debug:
        msg: >
          Le package 'subscription-manager' est introuvable dans les d√©p√¥ts
          activ√©s. Vous devez activer les d√©p√¥ts RHEL Base/AppStream avant
          de pouvoir continuer l‚Äôint√©gration Satellite.

# ----------------------------------------------------------------------
# 3Ô∏è‚É£ V√©rification de la version
# ----------------------------------------------------------------------
- name: "R√©cup√©rer la version de subscription-manager"
  ansible.builtin.shell: "rpm -q --qf '%{VERSION}' subscription-manager"
  changed_when: false
  register: _rhsm_ver
  failed_when: false

# ----------------------------------------------------------------------
# 4Ô∏è‚É£ V√©rifier si le syst√®me est d√©j√† enregistr√©
# ----------------------------------------------------------------------
- name: "D√©terminer si le syst√®me est d√©j√† enregistr√© aupr√®s du Satellite"
  ansible.builtin.command: "subscription-manager identity"
  changed_when: false
  register: _sm_identity
  failed_when: false

# ----------------------------------------------------------------------
# 5Ô∏è‚É£ V√©rifier la disponibilit√© du package CA Katello
# ----------------------------------------------------------------------
- name: "Tester disponibilit√© du package katello-ca-consumer"
  ansible.builtin.uri:
    url: "{{ _sat_ca_rpm }}"
    method: HEAD
    follow_redirects: safe
    status_code: [200]
  register: _ca_head
  failed_when: false

# ----------------------------------------------------------------------
# 6Ô∏è‚É£ Enregistrer la synth√®se
# ----------------------------------------------------------------------
- name: "Synth√®se package/rhsm"
  ansible.builtin.set_fact:
    sat_precheck: "{{ sat_precheck | combine({'checks': sat_precheck.checks | combine({
      'pkg_mgr': _pkg_mgr,
      'subscription_manager_present': (_rhsm_rpm.rc == 0) or (_rhsm_install is defined and _rhsm_install.changed),
      'subscription_manager_version_ok': (_rhsm_ver.stdout is version(min_subscription_manager_version, '>=')),
      'subscription_manager_installed_now': (_rhsm_install is defined and _rhsm_install.changed) | default(false),
      'already_registered': (_sm_identity.rc == 0),
      'katello_ca_available': (_ca_head.status | default(0)) == 200
    })}, recursive=True) }}"

# ----------------------------------------------------------------------
# 7Ô∏è‚É£ Messages r√©capitulatifs
# ----------------------------------------------------------------------
- name: "Afficher √©tat du package subscription-manager"
  ansible.builtin.debug:
    msg:
      - "Gestionnaire de paquets utilis√© : {{ _pkg_mgr }}"
      - "subscription-manager install√© : {{ (_rhsm_rpm.rc == 0) or (_rhsm_install is defined and _rhsm_install.changed) }}"
      - "Version : {{ _rhsm_ver.stdout | default('inconnue') }}"
      - "CA Katello accessible : {{ (_ca_head.status | default(0)) == 200 }}"


---

üí° Explications

√âtape	Description

1	V√©rifie si subscription-manager est install√© via rpm -q.
2	Si absent, v√©rifie sa disponibilit√© dans les d√©p√¥ts avec dnf list ou yum list, puis l‚Äôinstalle avec le module package.
3	R√©cup√®re la version install√©e (rpm -q --qf).
4	V√©rifie si le syst√®me est d√©j√† enregistr√©.
5	Teste la disponibilit√© du RPM CA Katello depuis le Satellite (HEAD sur /pub/...).
6	Met √† jour la variable sat_precheck.checks avec toutes les infos (pr√©sent, version, installation effectu√©e, etc.).
7	Affiche un r√©sum√© clair dans la sortie Ansible.



---

üß© R√©sultat JSON attendu (dans summary_output_path)

Exemple apr√®s ex√©cution :

"checks": {
  "pkg_mgr": "dnf",
  "subscription_manager_present": true,
  "subscription_manager_installed_now": false,
  "subscription_manager_version_ok": true,
  "already_registered": false,
  "katello_ca_available": true
}


---

Souhaites-tu que j‚Äôajoute aussi un param√®tre de contr√¥le (par ex. auto_install_subscription_manager: true|false) dans defaults/main.yml pour rendre cette installation optionnelle ?

